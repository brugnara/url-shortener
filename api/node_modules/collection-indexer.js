/**
 * Created by brugnara on 10/06/16,
 * @ daniele@brugnara.me
 */

var co = require('co');
var debug = require('debug')('url-shrtnr:collection-indexer');

module.exports = function(collections, extraIndexes) {

  if (!collections || !collections.url || !collections.stats) {
    throw new Error('Missing collections url and stats!');
  }

  co(function*() {

    debug('indexing db');

    yield [
      collections.stats.createIndex({ url_id: 1 }),
      collections.stats.createIndex({ date: 1 }),
      collections.stats.createIndex({ 'referer.hostname': 1 }),
      collections.stats.createIndex({ 'ua.browser.name': 1 }),
      collections.stats.createIndex({ 'ua.browser.major': 1 }),
      collections.stats.createIndex({ 'ua.engine.name': 1 }),
      collections.stats.createIndex({ 'ua.os.name': 1 }),
      collections.stats.createIndex({ 'ua.os.version': 1 })
    ];

    if (extraIndexes && Array.isArray(extraIndexes)) {
      var i = 0;
      var len = extraIndexes.length;

      while(i<len) {
        debug('ensuring index: %j', extraIndexes[i]);
        yield collections.stats.ensureIndex(extraIndexes[i++]);
      }

    }

    debug('db indexed');

  }).catch(function(e) {
    debug('error: %s\n%s', e.message, e.stack);
  });

};