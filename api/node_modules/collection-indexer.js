/**
 * Created by brugnara on 10/06/16,
 * @ daniele@brugnara.me
 */

var co = require('co');
var debug = require('debug')('url-shrtnr:collection-indexer');

module.exports = function(collections, extraIndexes) {

  if (!collections || !collections.url || !collections.stats) {
    throw new Error('Missing url and stats collection');
  }

  co(function*() {

    debug('indexing db');

    yield [
      collections.stats.ensureIndex({ url_id: 1 }),
      collections.stats.ensureIndex({ date: 1 }),
      collections.stats.ensureIndex({ 'referer.hostname': 1 }),
      collections.stats.ensureIndex({ ua: 1 }),
      collections.stats.ensureIndex({ extra: 1 })
    ];

    if (extraIndexes && Array.isArray(extraIndexes)) {
      var i = 0;
      var len = extraIndexes.length;

      while(i<len) {
        debug('ensuring index: %j', extraIndexes[i]);
        yield collections.stats.ensureIndex(extraIndexes[i++]);
      }

    }

    debug('db indexed');

  }).catch(function(e) {
    debug('error: %s\n%s', e.message, e.stack);
  });

};