/**
 * Created by brugnara on 09/06/16,
 * @ daniele@brugnara.me
 */

var Router = require('koa-router');
var chance = new (require('chance'))();

var debug = require('debug')('url-shrtnr:routes:url');

const DEFAULT_LEN = 5; // 36mln urls
const MAX_RETRY = 10;

module.exports = function(options) {

  options = options || {};

  var router = new Router();
  var length = options.length || DEFAULT_LEN;

  if (!options.collection) {
    throw new Error('Missing collection!');
  }

  router.post('/:url?', function*(next) {

    var url = this.params.url || this.request.body.url;

    if (!url) {
      this.throw(new Error('Missing url!'));
    }

    var done = false;
    var count = 0;
    var body;

    do {
      var _id = chance.word({ length: length });

      // dup entry id _id is already in use. retry until one valid is found
      try {

        body = {
          _id: _id,
          url: url,
          date: new Date()
        };

        yield options.collection.insert(body);

        done = true;
        debug('_id valid: %s', _id);

      } catch(e) {
        debug('_id already in use: %s', _id);
        debug(e.message);
        if (count++ > MAX_RETRY) {
          this.throw(new Error('Max retry reached'));
        }
      }
    } while (!done);

    this.body =Â body;

    yield next;
  });

  router.get('/:id', function*(next) {

    if (!this.params.id) {
      return this.throw(404, 'Url not found');
    }

    var _id = (this.params.id || '').replace('+', '');

    var urlInfo = yield options.collection
      .find({_id: _id}).limit(1).next();

    if (!urlInfo) {
      return this.throw(new Error('not found'));
    }

    // identico a bit.ly

    if (~this.params.id.indexOf('+')) {
      debug('showing urlInfo for: %s', urlInfo._id);
      this.body = urlInfo;
    } else {

      debug('302: redirecting user to: %s', urlInfo.url);

      this.status = 302;
      this.redirect(urlInfo.url);

      // TODO: contatori

    }

    yield next;
  });

  return router;

};