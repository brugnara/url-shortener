/**
 * Created by brugnara on 10/06/16,
 * @ daniele@brugnara.me
 */

var debug = require('debug')('url-shrtnr:incrementer');
var uaParser = require('ua-parser-js');
var objectCleaner = require('object-cleaner');
var url = require('url');

module.exports = function(collections) {

  if (!collections) {
    debug('missing stats collection');
    throw new Error('Missing collection');
  }

  return function*(url_id, info) {

    debug('doing increment for %s with data: %j', url_id, info);

    try {

      // update increments for single link

      yield collections.url.update({_id: url_id}, {
        $inc: {'stats.clicks': 1}
      });

    } catch(e) {
      debug('Error doing $inc: %s\n%s', e.message, e.stack);
    }

    try {

      //
      var payload = {
        url_id: url_id,
        date: new Date(),
        referer: {},
        ua: {}
      };

      // referer

      if (info.request.header.referer) {

        var uri = url.parse(info.request.header.referer);
        payload.referer = {
          original: info.request.header.referer,
          hostname: uri.hostname
        };

      }

      // uaparser

      if (info.request.header['user-agent']) {
        var ua = uaParser(info.request.header['user-agent']);
        delete ua.ua;
        payload.ua = objectCleaner(ua);
      }

      yield collections.stats.insert(payload);

    } catch(e) {
      debug('Error doing stats: %s\n%s', e.message, e.stack);
    }

  };

};